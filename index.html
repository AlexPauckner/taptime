<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TapTime">
  <meta name="theme-color" content="#1a1a2e">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <title>TapTime</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
      background: #1a1a2e;
      color: #e0e0e0;
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Header */
    .header {
      padding: 8px 16px;
      padding-top: max(8px, env(safe-area-inset-top));
      text-align: center;
      flex-shrink: 0;
    }

    .header h1 {
      font-size: 17px;
      font-weight: 700;
      color: #fff;
      letter-spacing: 1px;
    }

    .header .status {
      font-size: 12px;
      color: #888;
      margin-top: 2px;
      min-height: 16px;
    }

    .header .status.active {
      color: #4ade80;
    }

    /* Views */
    .view {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 4px 12px;
    }

    .view.active {
      display: flex;
      flex-direction: column;
    }

    /* 3-Column Grid ‚Äî Fullscreen */
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      flex: 1;
      align-content: start;
      padding: 4px 0;
    }

    /* Row separators (thematic groups) */
    .grid-separator {
      grid-column: 1 / -1;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: rgba(255, 255, 255, 0.25);
      padding: 6px 4px 2px;
    }

    .tile {
      position: relative;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 10px 6px;
      min-height: 88px;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      border: 3px solid transparent;
    }

    .tile:active {
      transform: scale(0.93);
    }

    .tile .emoji {
      font-size: 26px;
      margin-bottom: 3px;
    }

    .tile .label {
      font-size: 11px;
      font-weight: 600;
      text-align: center;
      line-height: 1.2;
      color: rgba(0, 0, 0, 0.8);
    }

    .tile .timer-display {
      font-size: 13px;
      font-weight: 700;
      margin-top: 3px;
      font-variant-numeric: tabular-nums;
      color: rgba(0, 0, 0, 0.9);
      display: none;
    }

    .tile.running {
      border-color: #fff;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
      animation: pulse 2s ease-in-out infinite;
    }

    .tile.running .timer-display {
      display: block;
    }

    .tile.custom-empty {
      background: rgba(255, 255, 255, 0.06);
      border: 2px dashed rgba(255, 255, 255, 0.2);
    }

    .tile.custom-empty .label { color: rgba(255, 255, 255, 0.3); }
    .tile.custom-empty .emoji { opacity: 0.4; }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 15px rgba(255, 255, 255, 0.2); }
      50% { box-shadow: 0 0 30px rgba(255, 255, 255, 0.5); }
    }

    /* Tile Colors ‚Äî Beruf: Blau/Lila/Indigo */
    .tile[data-cat="eiinh"] { background: #818cf8; }
    .tile[data-cat="eiinh"] .label,
    .tile[data-cat="eiinh"] .timer-display { color: rgba(255,255,255,0.95); }
    .tile[data-cat="bilderbuch"] { background: #a78bfa; }
    .tile[data-cat="bilderbuch"] .label,
    .tile[data-cat="bilderbuch"] .timer-display { color: rgba(255,255,255,0.95); }
    .tile[data-cat="ki-oekosystem"] { background: #6366f1; }
    .tile[data-cat="ki-oekosystem"] .label,
    .tile[data-cat="ki-oekosystem"] .timer-display { color: rgba(255,255,255,0.95); }
    .tile[data-cat="kita"] { background: #facc15; }
    .tile[data-cat="ki-fortbildung"] { background: #3b82f6; }
    .tile[data-cat="ki-fortbildung"] .label,
    .tile[data-cat="ki-fortbildung"] .timer-display { color: rgba(255,255,255,0.95); }
    .tile[data-cat="brainstorm"] { background: #a855f7; }
    .tile[data-cat="brainstorm"] .label,
    .tile[data-cat="brainstorm"] .timer-display { color: rgba(255,255,255,0.95); }

    /* Haushalt: Gr√ºn/Warm-T√∂ne */
    .tile[data-cat="kinder"] { background: #f9a8d4; }
    .tile[data-cat="hausarbeit"] { background: #4ade80; }
    .tile[data-cat="kueche"] { background: #86efac; }
    .tile[data-cat="kochen"] { background: #fb923c; }
    .tile[data-cat="einkaufen"] { background: #f87171; }
    .tile[data-cat="einkaufen"] .label,
    .tile[data-cat="einkaufen"] .timer-display { color: rgba(255,255,255,0.95); }
    .tile[data-cat="buchhaltung"] { background: #34d399; }

    /* Pers√∂nlich: Gelb/T√ºrkis */
    .tile[data-cat="jasmin"] { background: #fcd34d; }
    .tile[data-cat="freizeit"] { background: #2dd4bf; }

    /* Heute View */
    .today-header {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 12px;
      text-align: center;
    }

    .today-total {
      font-size: 14px;
      color: #888;
      text-align: center;
      margin-bottom: 16px;
    }

    .bar-container { margin-bottom: 14px; }

    .bar-label {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 4px;
      color: #ccc;
    }

    .bar-track {
      height: 28px;
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      border-radius: 8px;
      transition: width 0.3s ease;
    }

    .time-entries { padding: 4px 0 0 4px; }

    .time-entry {
      font-size: 11px;
      color: #999;
      padding: 2px 0;
      display: flex;
      justify-content: space-between;
    }

    .time-entry .time-range { font-variant-numeric: tabular-nums; }
    .time-entry .time-dur { color: #666; }

    /* Export View */
    .export-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 8px 0;
    }

    .export-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      padding: 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
    }

    .export-btn:active { background: rgba(255,255,255,0.2); }
    .export-btn .sub { font-size: 12px; font-weight: 400; color: #888; margin-top: 4px; }

    .export-feedback { text-align: center; font-size: 14px; color: #4ade80; min-height: 20px; }

    .danger-zone { margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); }

    .danger-btn {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
      padding: 14px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      width: 100%;
    }

    /* Bottom Nav */
    .nav {
      display: flex;
      border-top: 1px solid rgba(255,255,255,0.1);
      flex-shrink: 0;
      padding-bottom: max(8px, env(safe-area-inset-bottom));
      background: #1a1a2e;
    }

    .nav-btn {
      flex: 1;
      padding: 10px 0;
      text-align: center;
      cursor: pointer;
      color: #666;
      font-size: 11px;
      font-weight: 600;
      background: none;
      border: none;
    }

    .nav-btn .nav-icon { font-size: 22px; display: block; margin-bottom: 2px; }
    .nav-btn.active { color: #fff; }

    /* Correction Popup */
    .correction-popup {
      display: none;
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 80px;
      background: #2a2a4a;
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 16px;
      padding: 12px 16px;
      z-index: 50;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
      animation: slideUp 0.2s ease-out;
    }

    .correction-popup.show { display: block; }

    @keyframes slideUp {
      from { transform: translateX(-50%) translateY(20px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    .correction-label { font-size: 12px; color: #888; margin-bottom: 8px; }

    .correction-buttons { display: flex; gap: 8px; }

    .corr-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
    }

    .corr-btn:active { background: rgba(255,255,255,0.25); }

    .correction-current {
      font-size: 11px;
      color: #4ade80;
      margin-top: 8px;
      font-variant-numeric: tabular-nums;
    }

    /* Edit Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.show { display: flex; }

    .modal {
      background: #2a2a4a;
      border-radius: 20px;
      padding: 24px;
      width: 100%;
      max-width: 320px;
    }

    .modal h2 { font-size: 18px; color: #fff; margin-bottom: 16px; text-align: center; }

    .modal label {
      font-size: 13px; color: #aaa; display: block; margin-bottom: 4px; margin-top: 12px;
    }

    .modal input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color: #fff;
      font-size: 16px;
      font-family: inherit;
      outline: none;
    }

    .modal input[type="text"]:focus { border-color: rgba(255,255,255,0.4); }

    .color-picker { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 6px; }

    .color-dot {
      width: 36px; height: 36px; border-radius: 50%; cursor: pointer;
      border: 3px solid transparent; transition: border-color 0.2s, transform 0.1s;
    }

    .color-dot.selected { border-color: #fff; transform: scale(1.15); }

    .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }

    .modal-btn {
      flex: 1; padding: 12px; border-radius: 10px; font-size: 15px;
      font-weight: 600; cursor: pointer; border: none; font-family: inherit;
    }

    .modal-btn.cancel { background: rgba(255,255,255,0.1); color: #aaa; }
    .modal-btn.save { background: #3b82f6; color: #fff; }

    .modal-btn.reset {
      background: rgba(239, 68, 68, 0.2); color: #ef4444;
      font-size: 13px; padding: 8px; margin-top: 8px; width: 100%;
    }
  </style>
</head>
<body>

  <div class="header">
    <h1>TapTime</h1>
    <div class="status" id="headerStatus">Kein Timer aktiv</div>
  </div>

  <div class="view active" id="viewTimer">
    <div class="grid" id="grid"></div>
  </div>

  <div class="view" id="viewToday">
    <div class="today-header">Heute</div>
    <div class="today-total" id="todayTotal"></div>
    <div id="todayBars"></div>
  </div>

  <div class="view" id="viewExport">
    <div class="export-section">
      <div class="export-btn" onclick="exportJSON()">
        <div>üìã JSON kopieren</div>
        <div class="sub">Alle Eintr√§ge ‚Äî f√ºr Auswertung mit Claude</div>
      </div>
      <div class="export-btn" onclick="exportCSV()">
        <div>üìä CSV kopieren</div>
        <div class="sub">F√ºr Excel / Google Sheets</div>
      </div>
      <div class="export-btn" onclick="exportTodayText()">
        <div>üìù Heute als Text</div>
        <div class="sub">Zusammenfassung zum Teilen</div>
      </div>
      <div class="export-feedback" id="exportFeedback"></div>
      <div class="danger-zone">
        <div class="danger-btn" onclick="confirmClear()">üóëÔ∏è Alle Daten l√∂schen</div>
      </div>
    </div>
  </div>

  <!-- Correction Popup -->
  <div class="correction-popup" id="correctionPopup">
    <div class="correction-label">Startzeit korrigieren:</div>
    <div class="correction-buttons">
      <button class="corr-btn" data-minutes="5">‚àí5</button>
      <button class="corr-btn" data-minutes="15">‚àí15</button>
      <button class="corr-btn" data-minutes="30">‚àí30</button>
      <button class="corr-btn" data-minutes="60">‚àí60</button>
    </div>
    <div class="correction-current" id="correctionCurrent"></div>
  </div>

  <!-- Edit Modal for custom tiles -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <h2>Kachel konfigurieren</h2>
      <label>Name</label>
      <input type="text" id="editName" placeholder="z.B. Sport" maxlength="20">
      <label>Emoji</label>
      <input type="text" id="editEmoji" placeholder="z.B. ‚öΩ" maxlength="4">
      <label>Farbe</label>
      <div class="color-picker" id="colorPicker"></div>
      <div class="modal-buttons">
        <button class="modal-btn cancel" onclick="closeEditModal()">Abbrechen</button>
        <button class="modal-btn save" onclick="saveCustomTile()">Speichern</button>
      </div>
      <button class="modal-btn reset" id="resetBtn" onclick="resetCustomTile()">Zur√ºcksetzen (leeren)</button>
    </div>
  </div>

  <nav class="nav">
    <button class="nav-btn active" data-view="viewTimer">
      <span class="nav-icon">‚è±Ô∏è</span>Timer
    </button>
    <button class="nav-btn" data-view="viewToday">
      <span class="nav-icon">üìä</span>Heute
    </button>
    <button class="nav-btn" data-view="viewExport">
      <span class="nav-icon">üíæ</span>Export
    </button>
  </nav>

  <script>
    // ========================================
    // CATEGORIES ‚Äî thematisch sortiert (3er Grid)
    // ========================================
    const FIXED_CATEGORIES = [
      // Reihe 1: Beruf / Kreativ
      { id: 'eiinh', name: 'EIINH', emoji: 'üé¨', group: 'Beruf' },
      { id: 'bilderbuch', name: 'Bilderbuch', emoji: 'üìñ', group: 'Beruf' },
      { id: 'ki-oekosystem', name: 'KI-√ñkosystem', emoji: '‚öôÔ∏è', group: 'Beruf' },
      // Reihe 2: Beruf / Lernen
      { id: 'kita', name: 'Kita', emoji: 'üè´', group: 'Beruf' },
      { id: 'ki-fortbildung', name: 'KI-Fortbildung', emoji: 'üéì', group: 'Beruf' },
      { id: 'brainstorm', name: 'Brainstorm', emoji: 'üí°', group: 'Beruf' },
      // Reihe 3: Haushalt / Kinder
      { id: 'kinder', name: 'Kinder', emoji: 'üë∂', group: 'Haushalt' },
      { id: 'hausarbeit', name: 'Hausarbeit', emoji: 'üßπ', group: 'Haushalt' },
      { id: 'kueche', name: 'K√ºche', emoji: 'üçΩÔ∏è', group: 'Haushalt' },
      // Reihe 4: Haushalt / Versorgung
      { id: 'kochen', name: 'Kochen', emoji: 'üç≥', group: 'Haushalt' },
      { id: 'einkaufen', name: 'Einkaufen', emoji: 'üõí', group: 'Haushalt' },
      { id: 'buchhaltung', name: 'Buchhaltung', emoji: 'üìã', group: 'Haushalt' },
      // Reihe 5: Pers√∂nlich
      { id: 'jasmin', name: 'Zeit mit Jasmin', emoji: 'üíõ', group: 'Pers√∂nlich' },
      { id: 'freizeit', name: 'Freizeit', emoji: 'üéÆ', group: 'Pers√∂nlich' },
    ];

    const CUSTOM_SLOT_IDS = ['custom-1'];

    const AVAILABLE_COLORS = [
      '#ef4444', '#f97316', '#facc15', '#22c55e', '#06b6d4',
      '#3b82f6', '#8b5cf6', '#ec4899', '#f43f5e', '#14b8a6',
      '#a855f7', '#fbbf24', '#34d399', '#818cf8', '#fb923c',
    ];

    const DARK_BG_COLORS = ['#ef4444', '#3b82f6', '#8b5cf6', '#a855f7', '#818cf8', '#f43f5e', '#6366f1'];

    const CAT_COLORS = {
      'eiinh': '#818cf8', 'bilderbuch': '#a78bfa', 'ki-oekosystem': '#6366f1',
      'kita': '#facc15', 'ki-fortbildung': '#3b82f6', 'brainstorm': '#a855f7',
      'kinder': '#f9a8d4', 'hausarbeit': '#4ade80', 'kueche': '#86efac',
      'kochen': '#fb923c', 'einkaufen': '#f87171', 'buchhaltung': '#34d399',
      'jasmin': '#fcd34d', 'freizeit': '#2dd4bf',
    };

    // ========================================
    // STATE ‚Äî parallele Timer
    // ========================================
    let activeTimers = {};  // { catId: Date, ... }
    let entries = [];
    let timerInterval = null;
    let customTiles = {};
    let editingSlot = null;
    let correctionTarget = null;
    let correctionTimeout = null;

    // ========================================
    // LOCALSTORAGE
    // ========================================
    function loadData() {
      try {
        const raw = localStorage.getItem('taptime');
        if (!raw) return;
        const data = JSON.parse(raw);
        entries = data.entries || [];
        customTiles = data.customTiles || {};

        // Migration: singular activeTimer ‚Üí plural activeTimers
        if (data.activeTimer && !data.activeTimers) {
          activeTimers = {};
          activeTimers[data.activeTimer.category] = new Date(data.activeTimer.start);
        } else if (data.activeTimers) {
          activeTimers = {};
          for (const [catId, isoStr] of Object.entries(data.activeTimers)) {
            activeTimers[catId] = new Date(isoStr);
          }
        }
      } catch (e) {
        console.error('Fehler beim Laden:', e);
      }
    }

    function saveData() {
      const serializedTimers = {};
      for (const [catId, date] of Object.entries(activeTimers)) {
        serializedTimers[catId] = date.toISOString();
      }
      localStorage.setItem('taptime', JSON.stringify({
        entries,
        customTiles,
        activeTimers: serializedTimers
      }));
    }

    // ========================================
    // ALL CATEGORIES (fixed + custom)
    // ========================================
    function getAllCategories() {
      const cats = [...FIXED_CATEGORIES];
      CUSTOM_SLOT_IDS.forEach(slotId => {
        if (customTiles[slotId]) {
          cats.push({ id: slotId, name: customTiles[slotId].name, emoji: customTiles[slotId].emoji });
        }
      });
      return cats;
    }

    // ========================================
    // TIMER LOGIC ‚Äî parallel
    // ========================================
    function toggleCategory(catId) {
      if (navigator.vibrate) navigator.vibrate(50);

      if (activeTimers[catId]) {
        // Stop this one timer
        stopTimer(catId);
        hideCorrectionSlider();
      } else {
        // Start this timer (parallel ‚Äî don't stop others!)
        startTimer(catId);
        showCorrectionSlider(catId);
      }

      saveData();
      updateUI();
    }

    function startTimer(catId) {
      activeTimers[catId] = new Date();
      startTickInterval();
    }

    function stopTimer(catId) {
      const start = activeTimers[catId];
      if (!start) return;

      const end = new Date();
      const duration = Math.round((end - start) / 1000);
      if (duration > 5) {
        entries.push({
          category: catId,
          start: start.toISOString(),
          end: end.toISOString(),
          duration
        });
      }

      delete activeTimers[catId];

      if (Object.keys(activeTimers).length === 0) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function startTickInterval() {
      if (timerInterval) return;
      timerInterval = setInterval(updateTimerDisplays, 1000);
    }

    // ========================================
    // CORRECTION POPUP
    // ========================================
    function showCorrectionSlider(catId) {
      correctionTarget = catId;
      const popup = document.getElementById('correctionPopup');
      document.getElementById('correctionCurrent').textContent =
        `Start: ${formatTime(activeTimers[catId])}`;
      popup.classList.add('show');

      clearTimeout(correctionTimeout);
      correctionTimeout = setTimeout(hideCorrectionSlider, 5000);
    }

    function hideCorrectionSlider() {
      document.getElementById('correctionPopup').classList.remove('show');
      correctionTarget = null;
      clearTimeout(correctionTimeout);
    }

    function applyCorrection(minutes) {
      if (!correctionTarget || !activeTimers[correctionTarget]) return;
      if (navigator.vibrate) navigator.vibrate(30);

      const currentStart = activeTimers[correctionTarget];
      const newStart = new Date(currentStart.getTime() - minutes * 60 * 1000);

      // Don't go before midnight
      const midnight = new Date();
      midnight.setHours(0, 0, 0, 0);
      if (newStart < midnight) newStart.setTime(midnight.getTime());

      activeTimers[correctionTarget] = newStart;
      saveData();
      updateTimerDisplays();

      document.getElementById('correctionCurrent').textContent =
        `Start: ${formatTime(newStart)} (‚àí${minutes} Min)`;

      clearTimeout(correctionTimeout);
      correctionTimeout = setTimeout(hideCorrectionSlider, 3000);
    }

    // Correction button listeners
    document.querySelectorAll('.corr-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        applyCorrection(parseInt(btn.dataset.minutes));
      });
    });

    // Click outside closes popup
    document.addEventListener('click', (e) => {
      const popup = document.getElementById('correctionPopup');
      if (popup.classList.contains('show') && !popup.contains(e.target)) {
        hideCorrectionSlider();
      }
    });

    // ========================================
    // FORMAT HELPERS
    // ========================================
    function formatDuration(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      if (h > 0) return `${h}:${pad(m)}:${pad(s)}`;
      return `${m}:${pad(s)}`;
    }

    function formatHoursMinutes(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      if (h > 0) return `${h}h ${m}m`;
      return `${m}m`;
    }

    function pad(n) { return n.toString().padStart(2, '0'); }

    function formatTime(date) {
      if (typeof date === 'string') date = new Date(date);
      return `${pad(date.getHours())}:${pad(date.getMinutes())}`;
    }

    // ========================================
    // UI ‚Äî BUILD GRID
    // ========================================
    function buildGrid() {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';

      let lastGroup = '';
      FIXED_CATEGORIES.forEach((cat, i) => {
        // Add group separator on first item of each group
        if (cat.group !== lastGroup) {
          const sep = document.createElement('div');
          sep.className = 'grid-separator';
          sep.textContent = cat.group;
          grid.appendChild(sep);
          lastGroup = cat.group;
        }
        grid.appendChild(createTileElement(cat.id, cat.emoji, cat.name));
      });

      // Custom slot
      CUSTOM_SLOT_IDS.forEach(slotId => {
        const custom = customTiles[slotId];
        if (custom) {
          const tile = createTileElement(slotId, custom.emoji, custom.name);
          tile.style.background = custom.color;
          if (isColorDark(custom.color)) {
            tile.querySelector('.label').style.color = 'rgba(255,255,255,0.95)';
            tile.querySelector('.timer-display').style.color = 'rgba(255,255,255,0.95)';
          }
          grid.appendChild(tile);
        } else {
          grid.appendChild(createEmptySlot(slotId));
        }
      });
    }

    function createTileElement(catId, emoji, name) {
      const tile = document.createElement('div');
      tile.className = 'tile';
      tile.dataset.cat = catId;
      tile.innerHTML = `
        <span class="emoji">${emoji}</span>
        <span class="label">${name}</span>
        <span class="timer-display" id="timer-${catId}">0:00</span>
      `;
      tile.addEventListener('click', () => toggleCategory(catId));

      // Long press for custom tiles
      if (catId.startsWith('custom-')) {
        let pressTimer = null;
        let didLongPress = false;

        tile.addEventListener('touchstart', () => {
          didLongPress = false;
          pressTimer = setTimeout(() => {
            didLongPress = true;
            if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
            openEditModal(catId);
          }, 600);
        }, { passive: true });

        tile.addEventListener('touchend', (e) => {
          clearTimeout(pressTimer);
          if (didLongPress) { e.preventDefault(); e.stopImmediatePropagation(); }
        });

        tile.addEventListener('touchmove', () => clearTimeout(pressTimer), { passive: true });
      }

      return tile;
    }

    function createEmptySlot(slotId) {
      const tile = document.createElement('div');
      tile.className = 'tile custom-empty';
      tile.dataset.cat = slotId;
      tile.innerHTML = `
        <span class="emoji">‚ûï</span>
        <span class="label">Gedr√ºckt halten</span>
        <span class="timer-display" id="timer-${slotId}">0:00</span>
      `;
      tile.addEventListener('click', () => openEditModal(slotId));

      let pressTimer = null;
      tile.addEventListener('touchstart', () => {
        pressTimer = setTimeout(() => {
          if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
          openEditModal(slotId);
        }, 600);
      }, { passive: true });
      tile.addEventListener('touchend', () => clearTimeout(pressTimer));
      tile.addEventListener('touchmove', () => clearTimeout(pressTimer), { passive: true });

      return tile;
    }

    function isColorDark(hex) {
      if (!hex || !hex.startsWith('#')) return false;
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return (r * 299 + g * 587 + b * 114) / 1000 < 140;
    }

    // ========================================
    // UI ‚Äî UPDATE
    // ========================================
    function updateUI() {
      // Tile highlight
      document.querySelectorAll('.tile').forEach(tile => {
        tile.classList.toggle('running', !!activeTimers[tile.dataset.cat]);
      });

      // Header status
      const status = document.getElementById('headerStatus');
      const activeIds = Object.keys(activeTimers);

      if (activeIds.length === 0) {
        status.textContent = 'Kein Timer aktiv';
        status.className = 'status';
      } else if (activeIds.length === 1) {
        const allCats = getAllCategories();
        const cat = allCats.find(c => c.id === activeIds[0]);
        status.textContent = cat ? `${cat.emoji} ${cat.name} l√§uft...` : 'Timer l√§uft...';
        status.className = 'status active';
      } else {
        const allCats = getAllCategories();
        const emojis = activeIds.map(id => {
          const cat = allCats.find(c => c.id === id);
          return cat ? cat.emoji : '‚è±Ô∏è';
        }).join(' ');
        status.textContent = `${emojis} ${activeIds.length} Timer aktiv`;
        status.className = 'status active';
      }

      updateTimerDisplays();
    }

    function updateTimerDisplays() {
      for (const [catId, start] of Object.entries(activeTimers)) {
        const elapsed = Math.round((new Date() - start) / 1000);
        const display = document.getElementById(`timer-${catId}`);
        if (display) display.textContent = formatDuration(elapsed);
      }
    }

    // ========================================
    // EDIT MODAL (custom tiles)
    // ========================================
    function openEditModal(slotId) {
      editingSlot = slotId;
      const existing = customTiles[slotId];
      document.getElementById('editName').value = existing ? existing.name : '';
      document.getElementById('editEmoji').value = existing ? existing.emoji : '';
      document.getElementById('resetBtn').style.display = existing ? 'block' : 'none';

      const picker = document.getElementById('colorPicker');
      picker.innerHTML = '';
      const selectedColor = existing ? existing.color : AVAILABLE_COLORS[0];

      AVAILABLE_COLORS.forEach(color => {
        const dot = document.createElement('div');
        dot.className = 'color-dot' + (color === selectedColor ? ' selected' : '');
        dot.style.background = color;
        dot.addEventListener('click', () => {
          picker.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
          dot.classList.add('selected');
        });
        picker.appendChild(dot);
      });

      document.getElementById('editModal').classList.add('show');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('show');
      editingSlot = null;
    }

    function saveCustomTile() {
      const name = document.getElementById('editName').value.trim();
      const emoji = document.getElementById('editEmoji').value.trim();
      const selectedDot = document.querySelector('.color-dot.selected');
      const color = selectedDot ? rgbToHex(selectedDot.style.background) : AVAILABLE_COLORS[0];

      if (!name) { document.getElementById('editName').focus(); return; }

      customTiles[editingSlot] = { name, emoji: emoji || 'üìå', color };
      saveData();
      buildGrid();
      updateUI();
      closeEditModal();
    }

    function resetCustomTile() {
      if (!editingSlot) return;
      if (activeTimers[editingSlot]) {
        stopTimer(editingSlot);
        saveData();
      }
      delete customTiles[editingSlot];
      saveData();
      buildGrid();
      updateUI();
      closeEditModal();
    }

    function rgbToHex(color) {
      if (color.startsWith('#')) return color;
      const match = color.match(/\d+/g);
      if (!match || match.length < 3) return color;
      return '#' + match.slice(0, 3).map(n => parseInt(n).toString(16).padStart(2, '0')).join('');
    }

    // ========================================
    // TODAY VIEW
    // ========================================
    function updateTodayView() {
      const today = new Date().toISOString().slice(0, 10);
      const todayEntries = entries.filter(e => e.start.slice(0, 10) === today);

      const sums = {};
      todayEntries.forEach(e => {
        sums[e.category] = (sums[e.category] || 0) + e.duration;
      });

      // Add all active timers running today
      for (const [catId, start] of Object.entries(activeTimers)) {
        if (start.toISOString().slice(0, 10) === today) {
          const elapsed = Math.round((new Date() - start) / 1000);
          sums[catId] = (sums[catId] || 0) + elapsed;
        }
      }

      const totalSeconds = Object.values(sums).reduce((a, b) => a + b, 0);
      document.getElementById('todayTotal').textContent =
        totalSeconds > 0 ? `Gesamt: ${formatHoursMinutes(totalSeconds)}` : 'Noch keine Eintr√§ge heute';

      const maxSeconds = Math.max(...Object.values(sums), 1);
      const allCats = getAllCategories();
      const sorted = Object.entries(sums).sort((a, b) => b[1] - a[1]);
      const barsDiv = document.getElementById('todayBars');
      barsDiv.innerHTML = '';

      sorted.forEach(([catId, seconds]) => {
        const cat = allCats.find(c => c.id === catId);
        const catName = cat ? cat.name : catId;
        const catEmoji = cat ? cat.emoji : 'üìå';
        const pct = Math.max((seconds / maxSeconds) * 100, 8);
        let color = CAT_COLORS[catId] || '#666';
        if (customTiles[catId]) color = customTiles[catId].color;

        // Collect time entries
        const catEntries = todayEntries.filter(e => e.category === catId);
        let entriesHtml = '';
        catEntries.forEach(e => {
          entriesHtml += `<div class="time-entry"><span class="time-range">${formatTime(e.start)} ‚Äì ${formatTime(e.end)}</span><span class="time-dur">${formatHoursMinutes(e.duration)}</span></div>`;
        });

        // Active timer for this category
        if (activeTimers[catId]) {
          entriesHtml += `<div class="time-entry"><span class="time-range">${formatTime(activeTimers[catId])} ‚Äì jetzt</span><span class="time-dur" style="color:#4ade80;">l√§uft...</span></div>`;
        }

        barsDiv.innerHTML += `
          <div class="bar-container">
            <div class="bar-label">
              <span>${catEmoji} ${catName}</span>
              <span>${formatHoursMinutes(seconds)}</span>
            </div>
            <div class="bar-track">
              <div class="bar-fill" style="width:${pct}%;background:${color}"></div>
            </div>
            <div class="time-entries">${entriesHtml}</div>
          </div>
        `;
      });

      if (sorted.length === 0) {
        barsDiv.innerHTML = '<div style="text-align:center;color:#666;padding:40px 0;">Starte einen Timer, um Daten zu sehen</div>';
      }
    }

    // ========================================
    // EXPORT
    // ========================================
    function exportJSON() {
      const serializedTimers = {};
      for (const [catId, date] of Object.entries(activeTimers)) {
        serializedTimers[catId] = date.toISOString();
      }
      const data = { entries, customTiles, activeTimers: serializedTimers, exportDate: new Date().toISOString() };
      copyToClipboard(JSON.stringify(data, null, 2), 'JSON kopiert!');
    }

    function exportCSV() {
      const allCats = getAllCategories();
      let csv = 'Kategorie,Start,Ende,Dauer (Min)\n';
      entries.forEach(e => {
        const cat = allCats.find(c => c.id === e.category);
        const name = cat ? cat.name : e.category;
        const mins = Math.round(e.duration / 60 * 10) / 10;
        csv += `"${name}",${e.start},${e.end},${mins}\n`;
      });
      copyToClipboard(csv, 'CSV kopiert!');
    }

    function exportTodayText() {
      const today = new Date().toISOString().slice(0, 10);
      const todayEntries = entries.filter(e => e.start.slice(0, 10) === today);
      const allCats = getAllCategories();

      const sums = {};
      todayEntries.forEach(e => {
        sums[e.category] = (sums[e.category] || 0) + e.duration;
      });

      for (const [catId, start] of Object.entries(activeTimers)) {
        if (start.toISOString().slice(0, 10) === today) {
          const elapsed = Math.round((new Date() - start) / 1000);
          sums[catId] = (sums[catId] || 0) + elapsed;
        }
      }

      const totalSeconds = Object.values(sums).reduce((a, b) => a + b, 0);
      let text = `üìä TapTime ‚Äî ${today}\n`;
      text += `Gesamt: ${formatHoursMinutes(totalSeconds)}\n\n`;

      Object.entries(sums)
        .sort((a, b) => b[1] - a[1])
        .forEach(([catId, seconds]) => {
          const cat = allCats.find(c => c.id === catId);
          text += `${cat ? cat.emoji : 'üìå'} ${cat ? cat.name : catId}: ${formatHoursMinutes(seconds)}\n`;
        });

      copyToClipboard(text, 'Zusammenfassung kopiert!');
    }

    function copyToClipboard(text, msg) {
      navigator.clipboard.writeText(text).then(() => showFeedback(msg)).catch(() => {
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        showFeedback(msg);
      });
    }

    function showFeedback(msg) {
      const el = document.getElementById('exportFeedback');
      el.textContent = msg;
      setTimeout(() => { el.textContent = ''; }, 2000);
    }

    function confirmClear() {
      if (confirm('Wirklich ALLE Daten l√∂schen? Das kann nicht r√ºckg√§ngig gemacht werden.')) {
        entries = [];
        activeTimers = {};
        clearInterval(timerInterval);
        timerInterval = null;
        saveData();
        updateUI();
        showFeedback('Alle Daten gel√∂scht');
      }
    }

    // ========================================
    // NAVIGATION
    // ========================================
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const viewId = btn.dataset.view;
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        if (viewId === 'viewToday') updateTodayView();
      });
    });

    document.getElementById('editModal').addEventListener('click', (e) => {
      if (e.target.id === 'editModal') closeEditModal();
    });

    // ========================================
    // SERVICE WORKER + INIT
    // ========================================
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    loadData();
    buildGrid();
    updateUI();
    if (Object.keys(activeTimers).length > 0) startTickInterval();

    setInterval(() => {
      if (document.getElementById('viewToday').classList.contains('active')) {
        updateTodayView();
      }
    }, 10000);
  </script>
</body>
</html>
