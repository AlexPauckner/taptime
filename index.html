<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TapTime">
  <meta name="theme-color" content="#1a1a2e">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <title>TapTime</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
      background: #1a1a2e;
      color: #e0e0e0;
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      padding: 10px 16px;
      padding-top: max(10px, env(safe-area-inset-top));
      text-align: center;
      flex-shrink: 0;
    }

    .header h1 {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      letter-spacing: 1px;
    }

    .header .status {
      font-size: 12px;
      color: #888;
      margin-top: 2px;
    }

    .header .status.active {
      color: #4ade80;
    }

    .view {
      display: none;
      flex: 1;
      overflow-y: auto;
      padding: 4px 10px;
    }

    .view.active {
      display: flex;
      flex-direction: column;
    }

    /* 4x4 Grid */
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      flex: 1;
      align-content: center;
      padding: 2px 0;
    }

    .tile {
      position: relative;
      border-radius: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 8px 4px;
      min-height: 76px;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
      border: 3px solid transparent;
    }

    .tile:active {
      transform: scale(0.93);
    }

    .tile .emoji {
      font-size: 24px;
      margin-bottom: 2px;
    }

    .tile .label {
      font-size: 10px;
      font-weight: 600;
      text-align: center;
      line-height: 1.2;
      color: rgba(0, 0, 0, 0.8);
    }

    .tile .timer-display {
      font-size: 12px;
      font-weight: 700;
      margin-top: 2px;
      font-variant-numeric: tabular-nums;
      color: rgba(0, 0, 0, 0.9);
      display: none;
    }

    .tile.running {
      border-color: #fff;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
      animation: pulse 2s ease-in-out infinite;
    }

    .tile.running .timer-display {
      display: block;
    }

    .tile.custom-empty {
      background: rgba(255, 255, 255, 0.06);
      border: 2px dashed rgba(255, 255, 255, 0.2);
    }

    .tile.custom-empty .label {
      color: rgba(255, 255, 255, 0.3);
    }

    .tile.custom-empty .emoji {
      opacity: 0.4;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 15px rgba(255, 255, 255, 0.2); }
      50% { box-shadow: 0 0 30px rgba(255, 255, 255, 0.5); }
    }

    /* Tile Colors ‚Äî dark text by default, light text override for dark tiles */
    .tile[data-cat="kita"] { background: #facc15; }
    .tile[data-cat="brainstorm"] { background: #a855f7; }
    .tile[data-cat="brainstorm"] .label,
    .tile[data-cat="brainstorm"] .timer-display { color: rgba(255,255,255,0.95); }
    .tile[data-cat="ki-fortbildung"] { background: #3b82f6; }
    .tile[data-cat="ki-fortbildung"] .label,
    .tile[data-cat="ki-fortbildung"] .timer-display { color: rgba(255,255,255,0.95); }
    .tile[data-cat="ki-oekosystem"] { background: #06b6d4; }
    .tile[data-cat="hausarbeit"] { background: #22c55e; }
    .tile[data-cat="kueche"] { background: #86efac; }
    .tile[data-cat="kochen"] { background: #f97316; }
    .tile[data-cat="einkaufen"] { background: #ef4444; }
    .tile[data-cat="einkaufen"] .label,
    .tile[data-cat="einkaufen"] .timer-display { color: rgba(255,255,255,0.95); }
    .tile[data-cat="kinder"] { background: #f9a8d4; }
    .tile[data-cat="eiinh"] { background: #818cf8; }
    .tile[data-cat="eiinh"] .label,
    .tile[data-cat="eiinh"] .timer-display { color: rgba(255,255,255,0.95); }
    .tile[data-cat="bilderbuch"] { background: #fbbf24; }
    .tile[data-cat="finanzen"] { background: #34d399; }
    .tile[data-cat="freizeit"] { background: #2dd4bf; }

    /* Today View */
    .today-header {
      font-size: 18px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 12px;
      text-align: center;
    }

    .today-total {
      font-size: 14px;
      color: #888;
      text-align: center;
      margin-bottom: 16px;
    }

    .bar-container { margin-bottom: 14px; }

    .time-entries {
      padding: 4px 0 0 4px;
    }

    .time-entry {
      font-size: 11px;
      color: #999;
      padding: 2px 0;
      display: flex;
      justify-content: space-between;
    }

    .time-entry .time-range {
      font-variant-numeric: tabular-nums;
    }

    .time-entry .time-dur {
      color: #666;
    }

    .bar-label {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 4px;
      color: #ccc;
    }

    .bar-track {
      height: 28px;
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      border-radius: 8px;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      padding-left: 8px;
      font-size: 11px;
      font-weight: 600;
      color: rgba(0,0,0,0.7);
      min-width: fit-content;
    }

    /* Export View */
    .export-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 8px 0;
    }

    .export-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      padding: 16px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      transition: background 0.2s;
    }

    .export-btn:active { background: rgba(255,255,255,0.2); }

    .export-btn .sub {
      font-size: 12px;
      font-weight: 400;
      color: #888;
      margin-top: 4px;
    }

    .export-feedback {
      text-align: center;
      font-size: 14px;
      color: #4ade80;
      min-height: 20px;
    }

    .danger-zone {
      margin-top: auto;
      padding-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .danger-btn {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
      padding: 14px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
      width: 100%;
    }

    /* Bottom Nav */
    .nav {
      display: flex;
      border-top: 1px solid rgba(255,255,255,0.1);
      flex-shrink: 0;
      padding-bottom: max(8px, env(safe-area-inset-bottom));
      background: #1a1a2e;
    }

    .nav-btn {
      flex: 1;
      padding: 10px 0;
      text-align: center;
      cursor: pointer;
      color: #666;
      font-size: 11px;
      font-weight: 600;
      transition: color 0.2s;
      background: none;
      border: none;
    }

    .nav-btn .nav-icon {
      font-size: 22px;
      display: block;
      margin-bottom: 2px;
    }

    .nav-btn.active { color: #fff; }

    /* Edit Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal {
      background: #2a2a4a;
      border-radius: 20px;
      padding: 24px;
      width: 100%;
      max-width: 320px;
    }

    .modal h2 {
      font-size: 18px;
      color: #fff;
      margin-bottom: 16px;
      text-align: center;
    }

    .modal label {
      font-size: 13px;
      color: #aaa;
      display: block;
      margin-bottom: 4px;
      margin-top: 12px;
    }

    .modal input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.08);
      color: #fff;
      font-size: 16px;
      font-family: inherit;
      outline: none;
    }

    .modal input[type="text"]:focus {
      border-color: rgba(255,255,255,0.4);
    }

    .color-picker {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .color-dot {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: border-color 0.2s, transform 0.1s;
    }

    .color-dot.selected {
      border-color: #fff;
      transform: scale(1.15);
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-btn {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      font-family: inherit;
    }

    .modal-btn.cancel {
      background: rgba(255,255,255,0.1);
      color: #aaa;
    }

    .modal-btn.save {
      background: #3b82f6;
      color: #fff;
    }

    .modal-btn.reset {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      font-size: 13px;
      padding: 8px;
      margin-top: 8px;
      width: 100%;
    }
  </style>
</head>
<body>

  <div class="header">
    <h1>TapTime</h1>
    <div class="status" id="headerStatus">Kein Timer aktiv</div>
  </div>

  <div class="view active" id="viewTimer">
    <div class="grid" id="grid"></div>
  </div>

  <div class="view" id="viewToday">
    <div class="today-header">Heute</div>
    <div class="today-total" id="todayTotal"></div>
    <div id="todayBars"></div>
  </div>

  <div class="view" id="viewExport">
    <div class="export-section">
      <div class="export-btn" onclick="exportJSON()">
        <div>üìã JSON kopieren</div>
        <div class="sub">Alle Eintr√§ge ‚Äî f√ºr Auswertung mit Claude</div>
      </div>
      <div class="export-btn" onclick="exportCSV()">
        <div>üìä CSV kopieren</div>
        <div class="sub">F√ºr Excel / Google Sheets</div>
      </div>
      <div class="export-btn" onclick="exportTodayText()">
        <div>üìù Heute als Text</div>
        <div class="sub">Zusammenfassung zum Teilen</div>
      </div>
      <div class="export-feedback" id="exportFeedback"></div>
      <div class="danger-zone">
        <div class="danger-btn" onclick="confirmClear()">üóëÔ∏è Alle Daten l√∂schen</div>
      </div>
    </div>
  </div>

  <!-- Edit Modal for custom tiles -->
  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <h2>Kachel konfigurieren</h2>
      <label>Name</label>
      <input type="text" id="editName" placeholder="z.B. Sport" maxlength="20">
      <label>Emoji</label>
      <input type="text" id="editEmoji" placeholder="z.B. ‚öΩ" maxlength="4">
      <label>Farbe</label>
      <div class="color-picker" id="colorPicker"></div>
      <div class="modal-buttons">
        <button class="modal-btn cancel" onclick="closeEditModal()">Abbrechen</button>
        <button class="modal-btn save" onclick="saveCustomTile()">Speichern</button>
      </div>
      <button class="modal-btn reset" id="resetBtn" onclick="resetCustomTile()">Zur√ºcksetzen (leeren)</button>
    </div>
  </div>

  <nav class="nav">
    <button class="nav-btn active" data-view="viewTimer">
      <span class="nav-icon">‚è±Ô∏è</span>
      Timer
    </button>
    <button class="nav-btn" data-view="viewToday">
      <span class="nav-icon">üìä</span>
      Heute
    </button>
    <button class="nav-btn" data-view="viewExport">
      <span class="nav-icon">üíæ</span>
      Export
    </button>
  </nav>

  <script>
    // === Fixed Categories ===
    const FIXED_CATEGORIES = [
      { id: 'kita', name: 'Kita', emoji: 'üè´' },
      { id: 'brainstorm', name: 'Brainstorm', emoji: 'üí°' },
      { id: 'ki-fortbildung', name: 'KI-Fortbildung', emoji: 'üéì' },
      { id: 'ki-oekosystem', name: 'KI-√ñkosystem', emoji: '‚öôÔ∏è' },
      { id: 'hausarbeit', name: 'Hausarbeit', emoji: 'üßπ' },
      { id: 'kueche', name: 'K√ºche', emoji: 'üçΩÔ∏è' },
      { id: 'kochen', name: 'Kochen', emoji: 'üç≥' },
      { id: 'einkaufen', name: 'Einkaufen', emoji: 'üõí' },
      { id: 'kinder', name: 'Kinder', emoji: 'üë∂' },
      { id: 'eiinh', name: 'EIINH', emoji: 'üé¨' },
      { id: 'bilderbuch', name: 'Bilderbuch', emoji: 'üìñ' },
      { id: 'finanzen', name: 'Finanzen', emoji: 'üí∞' },
    ];

    // Custom tile slots (4 free slots)
    const CUSTOM_SLOT_IDS = ['custom-1', 'custom-2', 'custom-3', 'custom-4'];

    const AVAILABLE_COLORS = [
      '#ef4444', '#f97316', '#facc15', '#22c55e', '#06b6d4',
      '#3b82f6', '#8b5cf6', '#ec4899', '#f43f5e', '#14b8a6',
      '#a855f7', '#fbbf24', '#34d399', '#818cf8', '#fb923c',
    ];

    // Colors that need light text
    const DARK_BG_COLORS = ['#ef4444', '#3b82f6', '#8b5cf6', '#a855f7', '#818cf8', '#f43f5e'];

    const CAT_COLORS = {
      'kita': '#facc15',
      'brainstorm': '#a855f7',
      'ki-fortbildung': '#3b82f6',
      'ki-oekosystem': '#06b6d4',
      'hausarbeit': '#22c55e',
      'kueche': '#86efac',
      'kochen': '#f97316',
      'einkaufen': '#ef4444',
      'kinder': '#f9a8d4',
      'eiinh': '#818cf8',
      'bilderbuch': '#fbbf24',
      'finanzen': '#34d399',
      'freizeit': '#2dd4bf',
    };

    // === State ===
    let activeTimer = null;
    let entries = [];
    let timerInterval = null;
    let customTiles = {}; // { 'custom-1': { name: 'Sport', emoji: '‚öΩ', color: '#22c55e' }, ... }
    let editingSlot = null;

    // === localStorage ===
    function loadData() {
      try {
        const raw = localStorage.getItem('taptime');
        if (raw) {
          const data = JSON.parse(raw);
          entries = data.entries || [];
          customTiles = data.customTiles || {};
          if (data.activeTimer) {
            activeTimer = {
              category: data.activeTimer.category,
              start: new Date(data.activeTimer.start)
            };
          }
        }
      } catch (e) {
        console.error('Fehler beim Laden:', e);
      }
    }

    function saveData() {
      const data = {
        entries,
        customTiles,
        activeTimer: activeTimer ? {
          category: activeTimer.category,
          start: activeTimer.start.toISOString()
        } : null
      };
      localStorage.setItem('taptime', JSON.stringify(data));
    }

    // === Get all active categories (fixed + configured custom) ===
    function getAllCategories() {
      const cats = [...FIXED_CATEGORIES];
      CUSTOM_SLOT_IDS.forEach(slotId => {
        if (customTiles[slotId]) {
          cats.push({ id: slotId, name: customTiles[slotId].name, emoji: customTiles[slotId].emoji });
        }
      });
      return cats;
    }

    // === Timer Logic ===
    function toggleCategory(catId) {
      if (navigator.vibrate) navigator.vibrate(50);

      if (activeTimer && activeTimer.category === catId) {
        stopTimer();
      } else {
        if (activeTimer) stopTimer(false);
        startTimer(catId);
      }

      saveData();
      updateUI();
    }

    function startTimer(catId) {
      activeTimer = { category: catId, start: new Date() };
      startTickInterval();
    }

    function stopTimer(save = true) {
      if (!activeTimer) return;
      const end = new Date();
      const duration = Math.round((end - activeTimer.start) / 1000);
      if (duration > 5) {
        entries.push({
          category: activeTimer.category,
          start: activeTimer.start.toISOString(),
          end: end.toISOString(),
          duration
        });
      }
      activeTimer = null;
      if (save) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function startTickInterval() {
      clearInterval(timerInterval);
      timerInterval = setInterval(updateTimerDisplays, 1000);
    }

    // === Format helpers ===
    function formatDuration(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = seconds % 60;
      if (h > 0) return `${h}:${pad(m)}:${pad(s)}`;
      return `${m}:${pad(s)}`;
    }

    function formatHoursMinutes(seconds) {
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      if (h > 0) return `${h}h ${m}m`;
      return `${m}m`;
    }

    function pad(n) { return n.toString().padStart(2, '0'); }

    function formatTime(date) {
      if (typeof date === 'string') date = new Date(date);
      return `${pad(date.getHours())}:${pad(date.getMinutes())}`;
    }

    // === UI ===
    function buildGrid() {
      const grid = document.getElementById('grid');
      grid.innerHTML = '';

      // Fixed tiles
      FIXED_CATEGORIES.forEach(cat => {
        grid.appendChild(createTileElement(cat.id, cat.emoji, cat.name, false));
      });

      // Custom slots
      CUSTOM_SLOT_IDS.forEach(slotId => {
        const custom = customTiles[slotId];
        if (custom) {
          const tile = createTileElement(slotId, custom.emoji, custom.name, false);
          tile.style.background = custom.color;
          // Determine text color
          if (DARK_BG_COLORS.includes(custom.color) || isColorDark(custom.color)) {
            tile.querySelector('.label').style.color = 'rgba(255,255,255,0.95)';
            tile.querySelector('.timer-display').style.color = 'rgba(255,255,255,0.95)';
          }
          grid.appendChild(tile);
        } else {
          grid.appendChild(createEmptySlot(slotId));
        }
      });
    }

    function createTileElement(catId, emoji, name, isEmpty) {
      const tile = document.createElement('div');
      tile.className = 'tile';
      tile.dataset.cat = catId;
      tile.innerHTML = `
        <span class="emoji">${emoji}</span>
        <span class="label">${name}</span>
        <span class="timer-display" id="timer-${catId}">0:00</span>
      `;
      tile.addEventListener('click', () => toggleCategory(catId));

      // Long press for custom tiles (both configured and empty)
      if (catId.startsWith('custom-')) {
        let pressTimer = null;
        let didLongPress = false;

        tile.addEventListener('touchstart', (e) => {
          didLongPress = false;
          pressTimer = setTimeout(() => {
            didLongPress = true;
            if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
            openEditModal(catId);
          }, 600);
        }, { passive: true });

        tile.addEventListener('touchend', (e) => {
          clearTimeout(pressTimer);
          if (didLongPress) {
            e.preventDefault();
            // Prevent click from firing
            e.stopImmediatePropagation();
          }
        });

        tile.addEventListener('touchmove', () => {
          clearTimeout(pressTimer);
        }, { passive: true });
      }

      return tile;
    }

    function createEmptySlot(slotId) {
      const tile = document.createElement('div');
      tile.className = 'tile custom-empty';
      tile.dataset.cat = slotId;
      tile.innerHTML = `
        <span class="emoji">‚ûï</span>
        <span class="label">Gedr√ºckt halten</span>
        <span class="timer-display" id="timer-${slotId}">0:00</span>
      `;

      // Tap on empty = open config
      tile.addEventListener('click', () => openEditModal(slotId));

      // Also long press
      let pressTimer = null;
      tile.addEventListener('touchstart', () => {
        pressTimer = setTimeout(() => {
          if (navigator.vibrate) navigator.vibrate([50, 30, 50]);
          openEditModal(slotId);
        }, 600);
      }, { passive: true });
      tile.addEventListener('touchend', () => clearTimeout(pressTimer));
      tile.addEventListener('touchmove', () => clearTimeout(pressTimer), { passive: true });

      return tile;
    }

    function isColorDark(hex) {
      const r = parseInt(hex.slice(1, 3), 16);
      const g = parseInt(hex.slice(3, 5), 16);
      const b = parseInt(hex.slice(5, 7), 16);
      return (r * 299 + g * 587 + b * 114) / 1000 < 140;
    }

    function updateUI() {
      document.querySelectorAll('.tile').forEach(tile => {
        const isActive = activeTimer && activeTimer.category === tile.dataset.cat;
        tile.classList.toggle('running', isActive);
      });

      const status = document.getElementById('headerStatus');
      if (activeTimer) {
        const allCats = getAllCategories();
        const cat = allCats.find(c => c.id === activeTimer.category);
        status.textContent = cat ? `${cat.emoji} ${cat.name} l√§uft...` : 'Timer l√§uft...';
        status.className = 'status active';
      } else {
        status.textContent = 'Kein Timer aktiv';
        status.className = 'status';
      }

      updateTimerDisplays();
    }

    function updateTimerDisplays() {
      if (!activeTimer) return;
      const elapsed = Math.round((new Date() - activeTimer.start) / 1000);
      const display = document.getElementById(`timer-${activeTimer.category}`);
      if (display) display.textContent = formatDuration(elapsed);
    }

    // === Edit Modal ===
    function openEditModal(slotId) {
      editingSlot = slotId;
      const existing = customTiles[slotId];

      document.getElementById('editName').value = existing ? existing.name : '';
      document.getElementById('editEmoji').value = existing ? existing.emoji : '';
      document.getElementById('resetBtn').style.display = existing ? 'block' : 'none';

      // Build color picker
      const picker = document.getElementById('colorPicker');
      picker.innerHTML = '';
      const selectedColor = existing ? existing.color : AVAILABLE_COLORS[0];

      AVAILABLE_COLORS.forEach(color => {
        const dot = document.createElement('div');
        dot.className = 'color-dot' + (color === selectedColor ? ' selected' : '');
        dot.style.background = color;
        dot.addEventListener('click', () => {
          picker.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
          dot.classList.add('selected');
        });
        picker.appendChild(dot);
      });

      document.getElementById('editModal').classList.add('show');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('show');
      editingSlot = null;
    }

    function saveCustomTile() {
      const name = document.getElementById('editName').value.trim();
      const emoji = document.getElementById('editEmoji').value.trim();
      const selectedDot = document.querySelector('.color-dot.selected');
      const color = selectedDot ? selectedDot.style.background : AVAILABLE_COLORS[0];

      if (!name) {
        document.getElementById('editName').focus();
        return;
      }

      // Convert rgb to hex if needed
      const hexColor = rgbToHex(color);

      customTiles[editingSlot] = { name, emoji: emoji || 'üìå', color: hexColor };
      saveData();
      buildGrid();
      updateUI();
      closeEditModal();
    }

    function resetCustomTile() {
      if (!editingSlot) return;

      // Stop timer if running on this slot
      if (activeTimer && activeTimer.category === editingSlot) {
        stopTimer();
        saveData();
      }

      delete customTiles[editingSlot];
      saveData();
      buildGrid();
      updateUI();
      closeEditModal();
    }

    function rgbToHex(color) {
      if (color.startsWith('#')) return color;
      const match = color.match(/\d+/g);
      if (!match || match.length < 3) return color;
      return '#' + match.slice(0, 3).map(n => parseInt(n).toString(16).padStart(2, '0')).join('');
    }

    // === Today View ===
    function updateTodayView() {
      const today = new Date().toISOString().slice(0, 10);
      const todayEntries = entries.filter(e => e.start.slice(0, 10) === today);

      const sums = {};
      todayEntries.forEach(e => {
        sums[e.category] = (sums[e.category] || 0) + e.duration;
      });

      if (activeTimer && activeTimer.start.toISOString().slice(0, 10) === today) {
        const elapsed = Math.round((new Date() - activeTimer.start) / 1000);
        sums[activeTimer.category] = (sums[activeTimer.category] || 0) + elapsed;
      }

      const totalSeconds = Object.values(sums).reduce((a, b) => a + b, 0);
      document.getElementById('todayTotal').textContent =
        totalSeconds > 0 ? `Gesamt: ${formatHoursMinutes(totalSeconds)}` : 'Noch keine Eintr√§ge heute';

      const maxSeconds = Math.max(...Object.values(sums), 1);
      const allCats = getAllCategories();
      const sorted = Object.entries(sums).sort((a, b) => b[1] - a[1]);
      const barsDiv = document.getElementById('todayBars');
      barsDiv.innerHTML = '';

      sorted.forEach(([catId, seconds]) => {
        const cat = allCats.find(c => c.id === catId);
        const catName = cat ? cat.name : catId;
        const catEmoji = cat ? cat.emoji : 'üìå';
        const pct = Math.max((seconds / maxSeconds) * 100, 8);
        let color = CAT_COLORS[catId] || '#666';
        if (customTiles[catId]) color = customTiles[catId].color;

        // Collect time entries for this category
        const catEntries = todayEntries.filter(e => e.category === catId);
        let entriesHtml = '';
        catEntries.forEach(e => {
          const startTime = formatTime(new Date(e.start));
          const endTime = formatTime(new Date(e.end));
          const dur = formatHoursMinutes(e.duration);
          entriesHtml += `<div class="time-entry"><span class="time-range">${startTime} ‚Äì ${endTime}</span><span class="time-dur">${dur}</span></div>`;
        });

        // Show active timer entry if running
        if (activeTimer && activeTimer.category === catId) {
          const startTime = formatTime(activeTimer.start);
          entriesHtml += `<div class="time-entry"><span class="time-range">${startTime} ‚Äì jetzt</span><span class="time-dur" style="color:#4ade80;">l√§uft...</span></div>`;
        }

        barsDiv.innerHTML += `
          <div class="bar-container">
            <div class="bar-label">
              <span>${catEmoji} ${catName}</span>
              <span>${formatHoursMinutes(seconds)}</span>
            </div>
            <div class="bar-track">
              <div class="bar-fill" style="width:${pct}%;background:${color}"></div>
            </div>
            <div class="time-entries">${entriesHtml}</div>
          </div>
        `;
      });

      if (sorted.length === 0) {
        barsDiv.innerHTML = '<div style="text-align:center;color:#666;padding:40px 0;">Starte einen Timer, um Daten zu sehen</div>';
      }
    }

    // === Export ===
    function exportJSON() {
      const data = { entries, customTiles, exportDate: new Date().toISOString() };
      copyToClipboard(JSON.stringify(data, null, 2), 'JSON kopiert!');
    }

    function exportCSV() {
      const allCats = getAllCategories();
      let csv = 'Kategorie,Start,Ende,Dauer (Min)\n';
      entries.forEach(e => {
        const cat = allCats.find(c => c.id === e.category);
        const name = cat ? cat.name : e.category;
        const mins = Math.round(e.duration / 60 * 10) / 10;
        csv += `"${name}",${e.start},${e.end},${mins}\n`;
      });
      copyToClipboard(csv, 'CSV kopiert!');
    }

    function exportTodayText() {
      const today = new Date().toISOString().slice(0, 10);
      const todayEntries = entries.filter(e => e.start.slice(0, 10) === today);
      const allCats = getAllCategories();

      const sums = {};
      todayEntries.forEach(e => {
        sums[e.category] = (sums[e.category] || 0) + e.duration;
      });

      if (activeTimer && activeTimer.start.toISOString().slice(0, 10) === today) {
        const elapsed = Math.round((new Date() - activeTimer.start) / 1000);
        sums[activeTimer.category] = (sums[activeTimer.category] || 0) + elapsed;
      }

      const totalSeconds = Object.values(sums).reduce((a, b) => a + b, 0);
      let text = `üìä TapTime ‚Äî ${today}\n`;
      text += `Gesamt: ${formatHoursMinutes(totalSeconds)}\n\n`;

      Object.entries(sums)
        .sort((a, b) => b[1] - a[1])
        .forEach(([catId, seconds]) => {
          const cat = allCats.find(c => c.id === catId);
          text += `${cat ? cat.emoji : 'üìå'} ${cat ? cat.name : catId}: ${formatHoursMinutes(seconds)}\n`;
        });

      copyToClipboard(text, 'Zusammenfassung kopiert!');
    }

    function copyToClipboard(text, msg) {
      navigator.clipboard.writeText(text).then(() => {
        showFeedback(msg);
      }).catch(() => {
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        showFeedback(msg);
      });
    }

    function showFeedback(msg) {
      const el = document.getElementById('exportFeedback');
      el.textContent = msg;
      setTimeout(() => { el.textContent = ''; }, 2000);
    }

    function confirmClear() {
      if (confirm('Wirklich ALLE Daten l√∂schen? Das kann nicht r√ºckg√§ngig gemacht werden.')) {
        entries = [];
        activeTimer = null;
        clearInterval(timerInterval);
        saveData();
        updateUI();
        showFeedback('Alle Daten gel√∂scht');
      }
    }

    // === Navigation ===
    document.querySelectorAll('.nav-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const viewId = btn.dataset.view;
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        if (viewId === 'viewToday') updateTodayView();
      });
    });

    // Close modal on backdrop click
    document.getElementById('editModal').addEventListener('click', (e) => {
      if (e.target.id === 'editModal') closeEditModal();
    });

    // === Service Worker ===
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }

    // === Init ===
    loadData();
    buildGrid();
    updateUI();
    if (activeTimer) startTickInterval();

    setInterval(() => {
      if (document.getElementById('viewToday').classList.contains('active')) {
        updateTodayView();
      }
    }, 10000);
  </script>
</body>
</html>
